#!/bin/bash

POKEMONS=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
DIR="pokemon_data_parallel"

mkdir -p "$DIR"

echo "Starting parallel fetch..."

pids=()

for p in "${POKEMONS[@]}"; do
    echo "Fetching $p in background..."

    (
        curl -s -o "$DIR/$p.json" "https://pokeapi.co/api/v2/pokemon/$p"

        if [ $? -eq 0 ] && [ -s "$DIR/$p.json" ]; then
            echo "$p fetched successfully."
        else
            echo "Failed to fetch $p" >> errors_parallel.txt
        fi
    ) &

    pids+=($!)
done

# Timeout protection: if any process hangs more than 10 seconds, kill it
TIMEOUT=10
START=$(date +%s)

echo "Waiting for processes..."

for pid in "${pids[@]}"; do
    while kill -0 "$pid" 2>/dev/null; do
        NOW=$(date +%s)
        ELAPSED=$((NOW - START))

        if [ $ELAPSED -gt $TIMEOUT ]; then
            echo "Process $pid exceeded timeout. Killing..."
            kill -9 "$pid"
            echo "Killed PID $pid due to timeout" >> errors_parallel.txt
            break
        fi
        sleep 0.5
    done
done

echo "All parallel fetches completed."
